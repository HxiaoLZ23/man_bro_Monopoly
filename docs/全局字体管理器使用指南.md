# 全局字体管理器使用指南

## 概述

全局字体管理器是为解决项目中中文字体显示异常问题而设计的统一字体管理系统。它自动检测系统中可用的中文字体，并为所有界面提供统一的字体配置。

## 特性

- ✅ **自动字体检测**: 自动检测Windows、macOS、Linux系统中的中文字体
- ✅ **延迟初始化**: 等待pygame初始化后再加载字体，避免初始化顺序问题
- ✅ **多平台支持**: 支持Windows、macOS、Linux三大平台
- ✅ **备用机制**: 如果中文字体加载失败，自动使用默认字体
- ✅ **统一接口**: 提供简单易用的API接口
- ✅ **预定义大小**: 提供多种预定义的字体大小

## 支持的字体

### Windows
- 微软雅黑 (msyh.ttc) - 优先级最高
- 微软雅黑粗体 (msyhbd.ttc)
- 黑体 (simhei.ttf)
- 宋体 (simsun.ttc)
- 楷体 (simkai.ttf)
- 仿宋 (simfang.ttf)

### macOS
- 苹方 (PingFang.ttc)
- Helvetica
- Arial Unicode MS
- 华文黑体
- 华文宋体

### Linux
- 文泉驿正黑 (wqy-zenhei.ttc)
- 文泉驿微米黑 (wqy-microhei.ttc)
- DejaVu Sans
- Liberation Sans
- Noto Sans CJK

## 使用方法

### 1. 基本使用

```python
from src.ui.font_manager import get_font, render_text, get_text_size

# 获取字体对象
font = get_font("normal")  # 获取正常大小字体
title_font = get_font("title")  # 获取标题字体

# 直接渲染文本
text_surface = render_text("你好世界", "normal", (255, 255, 255), True)

# 获取文本尺寸
width, height = get_text_size("测试文本", "subtitle")
```

### 2. 可用的字体大小

| 大小名称 | 像素大小 | 用途 |
|---------|---------|------|
| `tiny` | 12px | 提示文本、状态信息 |
| `small` | 16px | 小号文本 |
| `body` | 16px | 正文内容 |
| `normal` | 24px | 普通文本 |
| `subheading` | 18px | 副标题 |
| `heading` | 24px | 标题 |
| `subtitle` | 32px | 副标题 |
| `title` | 48px | 主标题 |
| `large` | 64px | 大号标题 |

### 3. 在UI组件中使用

#### Button组件
```python
from src.ui.components import Button

button = Button(
    x=100, y=100, width=200, height=50,
    text="开始游戏",
    font_size="normal"  # 使用字体大小名称
)
```

#### Text组件
```python
from src.ui.components import Text

text = Text(
    x=100, y=100,
    text="游戏标题",
    font_size="title"  # 使用字体大小名称
)
```

### 4. 高级使用

#### 获取字体管理器实例
```python
from src.ui.font_manager import font_manager

# 获取当前字体路径
font_path = font_manager.get_font_path()
print(f"当前使用字体: {font_path}")

# 获取可用字体大小
sizes = font_manager.get_available_sizes()
print(f"可用大小: {sizes}")

# 重新加载字体（调试用）
font_manager.reload_fonts()
```

#### 自定义大小字体
```python
from src.ui.font_manager import get_font_by_size

# 获取指定像素大小的字体
custom_font = get_font_by_size(28)
```

## 迁移指南

### 从旧的字体系统迁移

#### 旧代码
```python
# 旧的方式
try:
    font = pygame.font.Font("C:/Windows/Fonts/msyh.ttc", 24)
except:
    font = pygame.font.Font(None, 24)

text_surface = font.render("文本", True, (255, 255, 255))
```

#### 新代码
```python
# 新的方式
from src.ui.font_manager import render_text

text_surface = render_text("文本", "normal", (255, 255, 255), True)
```

### 更新现有组件

1. **移除手动字体加载代码**
2. **导入字体管理器**
3. **使用字体大小名称替代像素值**
4. **使用统一的渲染函数**

## 最佳实践

### 1. 统一使用字体大小名称
```python
# ✅ 推荐
text_surface = render_text("标题", "title", color)

# ❌ 不推荐
font = pygame.font.Font(None, 48)
text_surface = font.render("标题", True, color)
```

### 2. 错误处理
```python
# 字体管理器已内置错误处理，无需额外处理
try:
    text_surface = render_text("文本", "normal", color)
except Exception as e:
    # 这种情况很少发生，字体管理器会自动使用备用字体
    print(f"渲染失败: {e}")
```

### 3. 性能优化
```python
# ✅ 推荐：缓存字体对象
class MyComponent:
    def __init__(self):
        self.font = get_font("normal")  # 初始化时获取一次
    
    def draw(self, surface):
        # 使用缓存的字体对象
        text_surface = self.font.render("文本", True, color)

# ❌ 不推荐：每次都获取字体
def draw_text():
    font = get_font("normal")  # 每次调用都获取
    text_surface = font.render("文本", True, color)
```

## 故障排除

### 常见问题

#### 1. 字体显示为方块
**原因**: 系统中没有安装中文字体  
**解决**: 字体管理器会自动使用默认字体，虽然可能显示为方块，但不会崩溃

#### 2. pygame未初始化错误
**原因**: 在pygame.init()之前调用字体管理器  
**解决**: 字体管理器已实现延迟初始化，会自动处理此问题

#### 3. 字体加载失败
**原因**: 字体文件损坏或权限问题  
**解决**: 字体管理器会自动尝试其他字体或使用默认字体

### 调试信息

字体管理器会输出详细的初始化信息：

```
🔤 初始化全局字体管理器...
✅ 成功加载字体文件: msyh.ttc
✅ 字体管理器初始化完成，使用字体: msyh.ttc
```

如果看到错误信息，说明字体加载失败：

```
❌ 字体加载失败 msyh.ttc: font not initialized
⚠️ 未找到合适的中文字体，使用默认字体
```

## 示例代码

### 完整的使用示例

```python
import pygame
from src.ui.font_manager import font_manager, get_font, render_text

def main():
    pygame.init()
    screen = pygame.display.set_mode((800, 600))
    
    # 字体管理器会自动初始化
    print(f"使用字体: {font_manager.get_font_path()}")
    
    # 渲染不同大小的文本
    title = render_text("游戏标题", "title", (255, 255, 255))
    subtitle = render_text("副标题", "subtitle", (200, 200, 200))
    content = render_text("游戏内容", "normal", (255, 255, 255))
    
    # 游戏循环
    running = True
    while running:
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                running = False
        
        screen.fill((0, 0, 0))
        screen.blit(title, (100, 100))
        screen.blit(subtitle, (100, 160))
        screen.blit(content, (100, 200))
        
        pygame.display.flip()
    
    pygame.quit()

if __name__ == "__main__":
    main()
```

## 总结

全局字体管理器解决了以下问题：

1. **中文显示异常** - 自动检测和加载中文字体
2. **重复代码** - 统一的字体获取和渲染接口
3. **平台兼容性** - 支持多平台字体路径
4. **错误处理** - 自动备用机制，避免程序崩溃
5. **开发效率** - 简化字体使用，专注业务逻辑

现在您可以在任何新界面中直接使用字体管理器，无需担心中文显示问题！ 