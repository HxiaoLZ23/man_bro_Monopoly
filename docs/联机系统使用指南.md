# 大富翁联机系统使用指南

## 📖 概述

大富翁联机系统是一个基于WebSocket的实时多人游戏系统，支持多房间并发游戏、状态同步、回合制管理和实时聊天等功能。

## 🏗️ 系统架构

### 核心组件

1. **网络协议层** (`src/network/protocol.py`)
   - 定义统一的消息格式和消息类型
   - 支持30+种消息类型，涵盖游戏的各个方面

2. **游戏状态同步管理器** (`src/network/sync_manager.py`)
   - 实时同步游戏状态
   - 支持完整同步和增量同步
   - 基于哈希的变化检测机制

3. **回合制管理器** (`src/network/turn_manager.py`)
   - 四阶段回合系统：准备→行动→结算→结束
   - 每阶段有特定的允许操作和超时时间
   - 支持自动跳过和手动操作

4. **聊天系统** (`src/network/chat_system.py`)
   - 多类型消息支持（公共、私聊、系统、游戏、通知）
   - 消息过滤和频率限制
   - 历史记录和在线状态管理

5. **联机游戏控制器** (`src/network/multiplayer_controller.py`)
   - 整合所有功能的统一控制器
   - 玩家管理、游戏控制、操作处理
   - 自动开始游戏和游戏结束检测

6. **游戏服务器** (`src/network/server/game_server.py`)
   - 基于WebSocket的异步服务器
   - 支持多房间并发游戏
   - 心跳检测和连接管理

## 🚀 快速开始

### 1. 安装依赖

```bash
pip install websockets
```

### 2. 启动服务器

```bash
# 使用默认配置启动 (localhost:8765)
python server_launcher.py

# 自定义配置启动
python server_launcher.py --host 0.0.0.0 --port 8888 --debug

# 查看帮助
python server_launcher.py --help
```

### 3. 测试客户端

```bash
# 连接到默认服务器
python test_client.py

# 连接到自定义服务器
python test_client.py --host 192.168.1.100 --port 8888
```

## 🎮 游戏流程

### 1. 连接和房间管理

```
客户端连接 → 获取房间列表 → 创建/加入房间 → 等待其他玩家
```

### 2. 游戏开始

```
房主开始游戏 → 初始化游戏状态 → 分配玩家顺序 → 开始第一回合
```

### 3. 回合制游戏

每个回合包含四个阶段：

1. **准备阶段** (5秒)
   - 显示当前玩家信息
   - 准备投骰子

2. **行动阶段** (30秒)
   - 投掷骰子
   - 移动棋子
   - 触发格子事件

3. **结算阶段** (15秒)
   - 处理房产购买/租金
   - 银行操作
   - 道具使用

4. **结束阶段** (5秒)
   - 清理临时状态
   - 切换到下一个玩家

### 4. 游戏结束

```
检测胜利条件 → 计算最终排名 → 显示结果 → 清理房间
```

## 📡 网络协议

### 消息格式

```json
{
    "message_type": "GAME_START",
    "data": {
        "players": [...],
        "map_data": {...},
        "game_config": {...}
    },
    "timestamp": 1234567890.123,
    "sender_id": "client_123",
    "room_id": "room_456"
}
```

### 主要消息类型

| 消息类型 | 说明 | 方向 |
|---------|------|------|
| `CREATE_ROOM` | 创建房间 | C→S |
| `JOIN_ROOM` | 加入房间 | C→S |
| `GAME_START` | 开始游戏 | C→S / S→C |
| `PLAYER_ACTION` | 玩家操作 | C→S |
| `GAME_STATE_SYNC` | 状态同步 | S→C |
| `CHAT_MESSAGE` | 聊天消息 | C→S / S→C |
| `TURN_START` | 回合开始 | S→C |
| `TURN_END` | 回合结束 | S→C |

## 🔧 客户端命令

测试客户端支持以下命令：

- `help` - 显示帮助信息
- `rooms` - 获取房间列表
- `create [房间名]` - 创建房间
- `join <房间ID> [玩家名]` - 加入房间
- `leave` - 离开房间
- `start` - 开始游戏（仅房主）
- `chat <消息>` - 发送聊天消息
- `action <操作> [数据]` - 执行游戏操作
- `quit/exit` - 退出客户端

## 🎯 游戏操作

### 基本操作

```bash
# 投掷骰子
action roll_dice

# 移动到指定位置
action move {"target_position": 10}

# 购买房产
action buy_property {"property_id": 5}

# 使用道具
action use_item {"item_id": "lucky_card", "target": "self"}
```

### 银行操作

```bash
# 存款
action bank_deposit {"amount": 1000}

# 取款
action bank_withdraw {"amount": 500}

# 申请贷款
action bank_loan {"amount": 2000}
```

### 商店操作

```bash
# 购买道具
action shop_buy {"item_id": "teleport_card", "quantity": 1}

# 出售道具
action shop_sell {"item_id": "lucky_card", "quantity": 2}
```

## 📊 状态同步

系统采用双重同步机制：

1. **完整同步** - 每10秒同步一次完整游戏状态
2. **增量同步** - 每0.5秒同步状态变化

### 同步内容

- 玩家位置和金钱
- 房产所有权
- 道具库存
- 游戏阶段和回合信息
- 地图状态

## 💬 聊天系统

### 消息类型

- **公共消息** - 房间内所有玩家可见
- **私聊消息** - 仅指定玩家可见
- **系统消息** - 服务器发送的系统通知
- **游戏消息** - 游戏事件相关消息
- **通知消息** - 重要提醒消息

### 消息过滤

- 消息长度限制（最大500字符）
- 发送频率限制（每秒最多3条）
- 敏感词过滤（可配置）

## 🔒 安全特性

1. **操作验证** - 验证玩家是否有权执行操作
2. **回合检查** - 确保操作在正确的回合阶段执行
3. **状态一致性** - 服务器端状态为权威状态
4. **消息过滤** - 防止恶意消息和垃圾信息
5. **连接管理** - 心跳检测和超时断开

## 📈 性能优化

1. **异步处理** - 所有网络操作都是异步的
2. **消息批量处理** - 减少网络开销
3. **状态缓存** - 避免重复计算和传输
4. **连接池管理** - 高效的连接资源管理
5. **内存清理** - 定期清理无用数据

## 🐛 故障排除

### 常见问题

1. **连接失败**
   - 检查服务器是否启动
   - 确认IP地址和端口正确
   - 检查防火墙设置

2. **消息发送失败**
   - 检查网络连接
   - 确认消息格式正确
   - 查看服务器日志

3. **游戏状态不同步**
   - 检查网络延迟
   - 确认客户端版本一致
   - 重新连接服务器

### 日志文件

- 服务器日志：`game_server.log`
- 客户端输出：控制台输出

## 🔮 扩展开发

### 添加新的消息类型

1. 在 `MessageType` 枚举中添加新类型
2. 在服务器中添加对应的处理函数
3. 在客户端中添加消息处理逻辑

### 添加新的游戏操作

1. 在 `TurnAction` 枚举中添加新操作
2. 在回合管理器中添加操作处理
3. 更新操作验证逻辑

### 自定义聊天功能

1. 继承 `ChatSystem` 类
2. 重写消息处理方法
3. 添加自定义过滤规则

## 📝 API 文档

详细的API文档请参考各个模块的docstring注释。

## 🤝 贡献指南

1. Fork 项目
2. 创建特性分支
3. 提交更改
4. 发起 Pull Request

## 📄 许可证

本项目采用 MIT 许可证。 